<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Listings</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #pagination {
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Job Listings</h1>

    <!-- Select Database -->
    <label for="dbFilter">Select Database:</label>
    <select id="dbFilter" onchange="fetchJobs(1)">
    </select>

    <label for="statusFilter">Filter by Status:</label>
    <select id="statusFilter" onchange="fetchJobs(1)">
        <!-- Status options will be populated here dynamically -->
    </select>

    <table id="jobTable">
        <thead>
            <tr>
                <th>Job Name</th>
                <th>Links</th>
                <th>Metadata</th>
                <th>Description</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Job rows will be dynamically inserted here -->
        </tbody>
    </table>

    <div id="pagination">
        <button id="prevPage" onclick="changePage(-1)" disabled>Previous</button>
        <span id="currentPage">Page 1</span>
        <button id="nextPage" onclick="changePage(1)" disabled>Next</button>
    </div>
    <br>
    <div>
      <a href="/scraper.html">
        Add new data
      </a>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;  // This will be updated by the server response
        statusOptions = [];
        async function fetchDatabases() {
            try {
                const response = await fetch('/databases');
                const data = await response.json();
                const dbSelect = document.getElementById('dbFilter');
                dbSelect.innerHTML = ''; // Clear previous options

                // Populate the database dropdown using a regular for loop
                for (let i = 0; i < data.databases.length; i++) {
                    const option = document.createElement('option');
                    option.value = data.databases[i];
                    option.text = data.databases[i];
                    dbSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching databases:', error);
            }
        }

        async function fetchStatusOptions() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                const statusSelect = document.getElementById('statusFilter');
                statusSelect.innerHTML = ''; // Clear previous options
                statusOptions = data.status;

                // Populate the filter status dropdown
                for (const status of data.status) {
                    const option = document.createElement('option');
                    option.value = status;
                    option.text = status.charAt(0).toUpperCase() + status.slice(1); // Capitalize first letter
                    statusSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Error fetching status options:', error);
            }
        }

        async function fetchJobs(page = 1) {
            const status = document.getElementById('statusFilter').value;
            const database = document.getElementById('dbFilter').value;

            const response = await fetch(`/jobs/${status}/${database}?page=${page}&per_page=10`);
            const data = await response.json();

            if (Array.isArray(data.jobs)) {
                const tbody = document.getElementById('jobTable').getElementsByTagName('tbody')[0];
                tbody.innerHTML = '';  // Clear previous rows

                // Loop over jobs and insert rows into the table
                for (const job of data.jobs) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${job.job_name}</td>
                        <td>
                          <a href="${job.author_link}" target="_blank">${job.author_name}</a>
                          |
                          <a href="${job.post_link}" target="_blank">Link</a>
                          </td>
                        <td>${job.metadata}</td>
                        <td>${job.body}</td>
                        <td>
                            <select id="status_${job.job_name}"></select>
                        </td>
                        <td>
                            <button onclick="updateJobStatus('${job.job_name}')">Update</button>
                        </td>
                    `;
                    populateStatusDropdowns(job); // Populate each status dropdown
                }

                // Update pagination controls
                currentPage = page;
                totalPages = data.total_pages;
                document.getElementById('currentPage').textContent = `Page ${currentPage}`;

                // Enable or disable pagination buttons based on current page
                document.getElementById('prevPage').disabled = currentPage <= 1;
                document.getElementById('nextPage').disabled = currentPage >= totalPages;
            } else {
                console.error('Expected jobs to be an array, but got:', data.jobs);
            }
        }

        function populateStatusDropdowns(job) {
            const statusDropdown = document.getElementById(`status_${job.job_name}`);
            statusDropdown.innerHTML = '';

            // Populate the dropdown with options
            for (let i = 0; i < statusOptions.length; i++) {
                const option = document.createElement('option');
                option.value = statusOptions[i];
                option.textContent = statusOptions[i].charAt(0).toUpperCase() + statusOptions[i].slice(1); // Capitalize first letter
                if (statusOptions[i] === job.status) {
                    option.selected = true; // Set the current status as selected
                }
                statusDropdown.appendChild(option);
            }
        }

        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage > 0 && newPage <= totalPages) {
                fetchJobs(newPage);
            }
        }

        async function updateJobStatus(jobName) {
            const status = document.getElementById(`status_${jobName}`).value;
            const database = document.getElementById('dbFilter').value;

            const response = await fetch(`/jobs/update/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    job_name: jobName,
                    db_name: database,
                    status: status 
                })
            });

            if (response.ok) {
                alert(`Job status updated to ${status}`);
            } else {
                console.error('Failed to update job status');
            }
        }

        // Fetch initial data (databases and status options) on page load
        window.onload = async () => {
            await fetchDatabases();
            await fetchStatusOptions();
            fetchJobs();
        };
    </script>

</body>
</html>
